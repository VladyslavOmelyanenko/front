---
import { urlFor } from "../lib/sanity.js";

const { workPost } = Astro.props;

const images = workPost.images ?? [];

const thumbUrls = images
  .map((item) => item?.image?.asset)
  .filter(Boolean)
  .map((asset) => urlFor(asset).width(200).auto("format").url());

const initialImages = thumbUrls.slice(0, 3);
---

<a
  href={"/works/" + workPost.slug}
  data-locked={workPost.isHidden ? "true" : "false"}
  class:list={{ locked: workPost.isHidden }}
>
  <div class="work-preview" data-images={JSON.stringify(thumbUrls)}>
    <h2 class="work-title">{workPost.title}</h2>

    <p class="work-short-description">
      <span class="ticker" data-ticker>
        <span class="t1">{workPost.postDescription}</span>
        <span class="t2">{workPost.postDescription}</span>
      </span>
    </p>

    {
      initialImages.map((url) => (
        <img class="work-image" src={url} loading="lazy" />
      ))
    }

    <span class="work-year">{new Date(workPost.postDate).getFullYear()}</span>
  </div>
</a>

<style lang="scss" is:global>
  @keyframes ticker {
    from {
      transform: translate3d(0, 0, 0);
    }
    to {
      transform: translate3d(calc(-1 * var(--ticker-distance, 0px)), 0, 0);
    }
  }

  .work-preview {
    height: 42px;
    display: flex;
    gap: 12px;

    &:hover {
      .work-title,
      .work-short-description,
      .work-year {
        box-shadow: 0 0 3px rgba(122, 122, 122, 0.4) inset;
      }
    }

    .work-title,
    .work-short-description,
    .work-year {
      border-radius: var(--br);
      backdrop-filter: var(--backdrop-filter);
      -webkit-backdrop-filter: var(--backdrop-filter);
      box-shadow: var(--box-shadow);
      text-align: center;
      padding: 0 8px;
      display: flex;
      align-items: center;
      white-space: nowrap;
    }

    .work-short-description {
      overflow: hidden;
      flex: 1;
      min-width: 0;
      position: relative;

      /* ✅ base: centered, no animation, no flicker */
      .ticker {
        width: max-content;
        display: inline-flex;
        white-space: nowrap;
        justify-content: center;
        animation: none;
        animation-play-state: paused;
        will-change: transform;
        transform: translate3d(0, 0, 0);
        backface-visibility: hidden;
      }

      /* ✅ always visible */
      .t1 {
        display: inline;
        padding-right: 0;
      }

      /* ✅ hidden by default */
      .t2 {
        display: none;
        padding-right: 40px;
      }

      /* ✅ only scroll when JS adds class */
      .ticker.is-scrolling {
        justify-content: flex-start;
        animation: ticker var(--ticker-duration, 12s) linear infinite;
        animation-play-state: paused;
      }

      .ticker.is-scrolling .t1 {
        padding-right: 40px;
      }

      .ticker.is-scrolling .t2 {
        display: inline;
      }
    }

    /* ✅ run only on hover (desktop) */
    &:hover .work-short-description .ticker.is-scrolling {
      animation-play-state: running;
    }

    .work-image {
      height: 100%;
      width: auto;
      border-radius: var(--br);
      border: 1.5px solid #d9d9d9;
      object-fit: cover;
    }
  }

  /* ===========================
   LOCKED: disable hover effects
=========================== */
  a.locked .work-preview {
    .work-title,
    .work-short-description,
    .work-year {
      color: #d9d9d9;
      cursor: not-allowed;
    }
  }

  a.locked .work-preview:hover {
    .work-title,
    .work-short-description,
    .work-year {
      box-shadow: var(--box-shadow);
    }
  }

  a.locked .work-preview:hover .work-short-description .ticker {
    animation-play-state: paused !important;
  }

  /* ===========================
   UNLOCKED: behave normal again
=========================== */
  html.works-unlocked a.locked .work-preview {
    .work-title,
    .work-short-description,
    .work-year {
      color: black;
      cursor: pointer;
    }
  }

  html.works-unlocked a.locked .work-preview:hover {
    .work-title,
    .work-short-description,
    .work-year {
      box-shadow: 0 0 3px rgba(122, 122, 122, 0.4) inset;
    }
  }

  html.works-unlocked
    a.locked
    .work-preview:hover
    .work-short-description
    .ticker.is-scrolling {
    animation-play-state: running !important;
  }

  @media (max-width: 768px) {
    .work-preview {
      .work-title {
        flex: 1;
        min-width: 0;
      }

      .work-short-description {
        display: none !important;
      }
    }
  }
</style>
