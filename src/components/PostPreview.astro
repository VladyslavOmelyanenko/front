---
import { urlFor } from "../lib/sanity.js";
const { post } = Astro.props;

const postDate =
  post?.postDate &&
  new Date(post.postDate).toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });

function truncateSmart(text, limit = 100) {
  if (!text || text.length <= limit) return text || "";
  const punctuation = /[.,!?;:]/g;
  let lastPunc = -1;
  let match;
  while ((match = punctuation.exec(text)) !== null) {
    if (match.index < limit) lastPunc = match.index;
    else break;
  }
  if (lastPunc > limit - 15) return text.slice(0, lastPunc + 1) + " ...";
  const lastSpace = text.lastIndexOf(" ", limit);
  return (
    (lastSpace === -1 ? text.slice(0, limit) : text.slice(0, lastSpace)) + "..."
  );
}

const desc = truncateSmart(post?.postDescription, 100);
const imgUrl =
  post?.postImage?.asset &&
  urlFor(post.postImage.asset).width(800).auto("format").url();
---

<div class="post-preview">
  <div class="title-bar">
    <h2>{post?.title || "Untitled Post"}</h2>
    {postDate && <p>{postDate}</p>}
  </div>

  {
    imgUrl && (
      <img src={imgUrl} alt={post?.title || "Post image"} loading="lazy" />
    )
  }

  {desc && <p class="post-description">{desc}</p>}
</div>

<style lang="scss">
  .post-preview {
    display: flex;
    flex-direction: column;
    gap: 10px;

    img {
      width: 50%;
      border-radius: 4px;
      object-fit: cover;
      align-self: center;
      margin: 50px 0;
    }

    .title-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
  }
</style>
