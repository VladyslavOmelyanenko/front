---
import Layout from "../../layouts/Layout.astro";
import NavForPost from "../../components/NavForPost.astro";
import Feed from "../../components/Feed.astro";
import { client } from "../../lib/sanity.js";
import Post from "../../components/Post.astro";
import { getWorkPost as getPostBySlug } from "../../data/works";

export async function getStaticPaths() {
  const slugs = await client.fetch(`
    *[_type == "post" && defined(slug.current) && !(_id in path("drafts.**"))]{
      "slug": slug.current
    }
  `);

  return slugs.map(({ slug }) => ({
    params: { slug },
    props: { postSlug: slug },
  }));
}

const { postSlug } = Astro.props;
const post = await getPostBySlug(postSlug);
if (!post) return Astro.redirect("/404");

const postDate = (() => {
  const d = new Date(post.postDate);

  return d.toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
})();

// The logic:
const displayTitle =
  post.title && post.title.trim() !== "" ? post.title : postDate;
---

<Layout title={`Dzastins Zavadzkisâ€”${postDate}`}>
  <NavForPost title={displayTitle} />
  <Feed>
    <Post post={post} />
  </Feed>
</Layout>
