---
import { client } from "../lib/sanity.js";
import { urlFor } from "../lib/sanity.js";

import Layout from "../layouts/Layout.astro";

export async function getHomepageImages() {
  return client.fetch(`
    *[_type == "homepage"][0]{
      featuredImages[]{
        asset,
        alt
      }
    }
  `);
}

const data = await getHomepageImages();
const images = data?.featuredImages ?? [];

// keep only valid assets
const assets = images.filter((img) => img && img.asset);

// build hi-res & low-res URLs on the server (Astro)
const hiResUrls = assets.map((img) =>
  urlFor(img.asset)
    .width(1920) // adjust if you like
    .height(1080)
    .fit("max") // keep aspect ratio, no crop
    .quality(85)
    .url()
);

const lowResUrls = assets.map((img) =>
  urlFor(img.asset).width(64).height(64).fit("max").quality(20).url()
);

// simple first placeholder (real start index is randomized on the client)
const firstLow = lowResUrls[0] ?? null;
---

<Layout>
  <div
    class="slideshow"
    data-hi={JSON.stringify(hiResUrls)}
    data-low={JSON.stringify(lowResUrls)}
  >
    {
      firstLow && (
        <img
          class="slideshow-image slideshow-image-primary loading"
          src={firstLow}
          alt="Featured slide"
          loading="lazy"
        />
      )
    }
  </div>
</Layout>

<script>
  (function initSlideshow() {
    const gallery = document.querySelector(".slideshow");
    if (!gallery) return;

    const primary = gallery.querySelector(".slideshow-image-primary");
    if (!primary) return;

    // Always create a secondary image.
    // On desktop it's hidden by CSS; on mobile it's shown under the first.
    const secondary = primary.cloneNode(false);
    secondary.removeAttribute("src");
    secondary.classList.remove("slideshow-image-primary");
    secondary.classList.add("slideshow-image-secondary");
    secondary.classList.remove("loading");
    secondary.style.opacity = "0";
    gallery.appendChild(secondary);

    let hi = [];
    let low = [];

    try {
      hi = JSON.parse(gallery.dataset.hi || "[]");
      low = JSON.parse(gallery.dataset.low || "[]");
    } catch {
      hi = [];
      low = [];
    }

    if (!hi.length) return;

    // ðŸ”€ Random starting index on the client
    let currentIndex = Math.floor(Math.random() * hi.length);
    let nextIndex =
      hi.length > 1 ? (currentIndex + 1) % hi.length : currentIndex;

    function preload(idx) {
      const pre = new Image();
      pre.src = hi[idx];
    }

    function showPair(a, b) {
      const lowA = low[a];
      const hiA = hi[a];
      const lowB = low[b];
      const hiB = hi[b];

      // start transition: fade both out
      primary.classList.add("loading");
      secondary.classList.add("loading");
      primary.style.opacity = "0";
      secondary.style.opacity = "0";

      // low-res placeholders immediately
      if (lowA) primary.src = lowA;
      if (lowB) secondary.src = lowB;

      const hiImgA = new Image();
      const hiImgB = new Image();

      hiImgA.src = hiA;
      hiImgA.onload = () => {
        primary.src = hiA;
        primary.classList.remove("loading");
        requestAnimationFrame(() => {
          primary.style.opacity = "1";
        });
      };

      hiImgB.src = hiB;
      hiImgB.onload = () => {
        secondary.src = hiB;
        secondary.classList.remove("loading");
        requestAnimationFrame(() => {
          secondary.style.opacity = "1";
        });
      };

      // Preload the one after `b`
      const preloadIndex = (b + 1) % hi.length;
      preload(preloadIndex);
    }

    // initial pair
    showPair(currentIndex, nextIndex);

    gallery.addEventListener("click", () => {
      // slide the window:
      // new current = old next
      // new next = next after that
      currentIndex = nextIndex;
      nextIndex = (nextIndex + 1) % hi.length;
      showPair(currentIndex, nextIndex);
    });

    window.addEventListener("resize", () => {
      // re-show current pair on resize; helps when crossing mobile/desktop breakpoint
      showPair(currentIndex, nextIndex);
    });
  })();
</script>

<style lang="scss">
  .slideshow {
    position: fixed;
    inset: 0; /* top:0; right:0; bottom:0; left:0 */
    display: flex;
    align-items: center;
    justify-content: center;
    background: #000;
    cursor: pointer;
    z-index: 999;
    overflow: hidden;
  }

  .slideshow-image-primary,
  .slideshow-image-secondary {
    width: 100vw;
    height: 100vh;
    object-fit: cover; /* center & cover screen */
    display: block;

    /* PERF: only animate opacity/transform (filter is expensive in Chrome) */
    transition:
      opacity 0.4s ease-out,
      transform 0.3s ease-out;

    opacity: 1;
    will-change: opacity, transform;

    /* helps Chrome keep this on its own layer */
    transform: translateZ(0);
    backface-visibility: hidden;
  }

  /* Secondary is hidden on desktop, but still kept in sync/preloaded */
  .slideshow-image-secondary {
    display: none;
  }

  /* blurred low-res placeholder
     NOTE: blur filters are expensive; keep, but reduce blur amount */
  .slideshow-image-primary.loading,
  .slideshow-image-secondary.loading {
    filter: blur(6px);
    transform: translateZ(0) scale(1.02);
  }

  /* === Mobile: show both images stacked (current + next) === */
  @media (max-width: 768px) {
    .slideshow {
      flex-direction: column;
    }

    .slideshow-image-primary,
    .slideshow-image-secondary {
      width: 100vw;
      height: 50vh;
      display: block;
    }
  }

  /* Optional: users who prefer reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .slideshow-image-primary,
    .slideshow-image-secondary {
      transition: none;
    }
  }
</style>
