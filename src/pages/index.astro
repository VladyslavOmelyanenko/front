---
import { client } from "../lib/sanity.js";
import { urlFor } from "../lib/sanity.js";

import Layout from "../layouts/Layout.astro";

export async function getHomepageImages() {
  return client.fetch(`
    *[_type == "homepage"][0]{
      featuredImages[]{
        asset,
        alt
      }
    }
  `);
}

const data = await getHomepageImages();
const images = data?.featuredImages ?? [];
const assets = images.filter((img) => img && img.asset);

const hiResUrls = assets.map((img) =>
  urlFor(img.asset).width(1920).height(1080).fit("max").quality(85).url()
);

const lowResUrls = assets.map((img) =>
  urlFor(img.asset).width(64).height(64).fit("max").quality(20).url()
);

const firstLow = lowResUrls[0] ?? null;
---

<Layout>
  <div
    class="slideshow"
    data-hi={JSON.stringify(hiResUrls)}
    data-low={JSON.stringify(lowResUrls)}
  >
    {
      firstLow && (
        <img
          class="slideshow-image slideshow-image-primary loading is-visible"
          src={firstLow}
          alt="Featured slide"
          loading="lazy"
        />
      )
    }
  </div>
</Layout>

<script>
  (function initSlideshow() {
    const gallery = document.querySelector(".slideshow");
    if (!gallery) return;

    const primary = gallery.querySelector(".slideshow-image-primary");
    if (!primary) return;

    // Create secondary image (used for crossfade)
    const secondary = primary.cloneNode(false);
    secondary.removeAttribute("src");
    secondary.classList.remove("slideshow-image-primary");
    secondary.classList.add("slideshow-image-secondary");
    secondary.classList.remove("loading");
    secondary.classList.remove("is-visible");
    gallery.appendChild(secondary);

    let hi = [];
    let low = [];

    try {
      hi = JSON.parse(gallery.dataset.hi || "[]");
      low = JSON.parse(gallery.dataset.low || "[]");
    } catch {
      hi = [];
      low = [];
    }

    if (!hi.length) return;

    let currentIndex = Math.floor(Math.random() * hi.length);
    let nextIndex =
      hi.length > 1 ? (currentIndex + 1) % hi.length : currentIndex;

    // which element is currently visible?
    let front = primary; // visible
    let back = secondary; // hidden

    function preload(idx) {
      const pre = new Image();
      pre.src = hi[idx];
    }

    function setImg(el, idx) {
      const lowSrc = low[idx];
      const hiSrc = hi[idx];

      // low-res first (optional), then swap to hi-res when loaded
      if (lowSrc) {
        el.classList.add("loading");
        el.src = lowSrc;
      }

      const hiImg = new Image();
      hiImg.src = hiSrc;
      hiImg.onload = () => {
        el.src = hiSrc;
        el.classList.remove("loading");
      };
    }

    function crossfadeTo(idx) {
      // Load next into the hidden layer
      setImg(back, idx);

      // Crossfade: back becomes visible, front becomes hidden
      back.classList.add("is-visible");
      front.classList.remove("is-visible");

      // Swap references
      const tmp = front;
      front = back;
      back = tmp;
    }

    // Initial: show current on front, preload next
    setImg(front, currentIndex);
    if (hi.length > 1) preload(nextIndex);

    gallery.addEventListener("click", () => {
      if (!hi.length) return;

      // Crossfade to next
      crossfadeTo(nextIndex);

      // advance indices
      currentIndex = nextIndex;
      nextIndex = (nextIndex + 1) % hi.length;

      // preload the one after next
      preload(nextIndex);
    });

    window.addEventListener("resize", () => {
      // keep current visible on resize; no forced re-crossfade
      // (optional: you can re-set sources if you need)
    });
  })();
</script>

<style lang="scss">
  .slideshow {
    position: fixed;
    inset: 0;
    background: #000;
    cursor: pointer;
    z-index: 999;
    overflow: hidden;
  }

  /* Desktop: layer images on top of each other for crossfade */
  .slideshow-image-primary,
  .slideshow-image-secondary {
    position: absolute;
    inset: 0;
    width: 100vw;
    height: 100vh;
    object-fit: cover;
    display: block;

    /* âœ… crossfade 6s ease-in-out */
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
    will-change: opacity;
  }

  .slideshow-image-primary.is-visible,
  .slideshow-image-secondary.is-visible {
    opacity: 1;
  }

  /* Optional: keep your "loading" look (no transition on blur; just a state) */
  .slideshow-image-primary.loading,
  .slideshow-image-secondary.loading {
    filter: blur(6px);
    transform: scale(1.02);
  }

  /* === Mobile: show both images stacked (current + next) === */
  @media (max-width: 768px) {
    .slideshow {
      display: flex;
      flex-direction: column;
    }

    .slideshow-image-primary,
    .slideshow-image-secondary {
      position: static; /* stop layering */
      width: 100vw;
      height: 50vh;
      opacity: 1; /* always visible when stacked */
      transition: none; /* no crossfade in stacked mode */
    }

    .slideshow-image-secondary {
      display: block;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .slideshow-image-primary,
    .slideshow-image-secondary {
      transition: none;
    }
  }
</style>
