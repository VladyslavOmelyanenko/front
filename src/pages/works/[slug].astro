---
import Layout from "../../layouts/Layout.astro";
import NavForPost from "../../components/NavForPost.astro";
import Feed from "../../components/Feed.astro";
import Post from "../../components/Post.astro";

import { client } from "../../lib/sanity.js";
import { getWorkPost as getPostBySlug } from "../../data/works";

import { createClient } from "@supabase/supabase-js";
import PrivatePostClient from "../../components/PrivatePostContent"

export async function getStaticPaths() {
  const publicSlugs = await client.fetch(`
    *[_type == "post"
      && postType == "work"
      && defined(slug.current)
      && !(_id in path("drafts.**"))
    ]{
      "slug": slug.current
    }
  `);

  const supabase = createClient(
    import.meta.env.SUPABASE_URL,
    import.meta.env.SUPABASE_SERVICE_ROLE_KEY,
  );

  const { data: hiddenSlugs } = await supabase
    .from("private_posts_preview")
    .select("slug");

  const all = [
    ...(publicSlugs || []).map((x) => x.slug),
    ...(hiddenSlugs || []).map((x) => x.slug),
  ];

  const unique = [...new Set(all)];

  return unique.map((slug) => ({ params: { slug } }));
}

const { slug } = Astro.params;

const post = await getPostBySlug(slug);
const isPublic = !!post;
---

{
  isPublic ? (
    <Layout title={`Dzastins Zavadzkis—${post.title}`}>
      <div class="post-page">
        <Feed>
          <NavForPost title={post.title} />
          <Post post={post} />
        </Feed>
      </div>
    </Layout>
  ) : (
    <Layout title="Dzastins Zavadzkis—Hidden Project">
      <div class="post-page">
        <Feed>
          <NavForPost title="Hidden Project" />

          {/* ✅ this now renders the same UI as Sanity (PostContent) */}
          <PrivatePostClient client:load />
        </Feed>
      </div>
    </Layout>
  )
}

<style lang="scss">
  .post-page {
    padding-bottom: 40px;
  }

  .post-pagination {
    margin-top: 40px;
    display: flex;
    justify-content: space-between;
    gap: 10px;
    align-items: flex-start; /* allow right stack height */
  }

  .page-btn {
    // background: var(--gray);
    height: 42px;
    border-radius: var(--br);
    padding: 0px 14px;
    text-decoration: none;
    color: #000;
    display: inline-flex;
    align-items: center;
    max-width: 48%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    box-shadow: var(--box-shadow);
    backdrop-filter: var(--backdrop-filter);
    -webkit-backdrop-filter: var(--backdrop-filter);
    transition:
      backdrop-filter 0.15s ease,
      box-shadow 0.15s ease;
  }

  .page-btn:hover {
    box-shadow: 0 0 0 rgba(122, 122, 122, 0.9);
  }

  .page-btn.disabled {
    opacity: 0.35;
    pointer-events: none;
  }

  /* RIGHT stack: Previous above Next */
  .right-stack {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 10px;
    max-width: 48%;
  }

  .right-stack .page-btn {
    max-width: 100%;
  }

  /* Creditbox stays on left */
  .creditbox {
    max-width: 48%;
    white-space: normal;
    overflow: visible;
    text-overflow: unset;
    font-size: calc(var(--fz) * 0.6);
    line-height: calc(var(--lh) * 0.65);
    text-align: left;
  }

  .creditbox :global(p) {
    margin: 0;
  }

  .creditbox :global(a) {
    text-decoration: underline;
    color: var(--gray);
  }
</style>
