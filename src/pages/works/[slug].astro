---
import Layout from "../../layouts/Layout.astro";
import NavForPost from "../../components/NavForPost.astro";
import Feed from "../../components/Feed.astro";
import Post from "../../components/Post.astro";

import { client } from "../../lib/sanity.js";
import { getWorkPost as getPostBySlug } from "../../data/works";

import { createClient } from "@supabase/supabase-js";
import PrivatePostClient from "../../components/PrivatePostContent.jsx";
import { PortableText } from "@portabletext/react";

export async function getStaticPaths() {
  // ✅ Sanity public works
  const publicSlugs = await client.fetch(`
    *[_type == "post"
      && postType == "work"
      && defined(slug.current)
      && !(_id in path("drafts.**"))
    ]{
      "slug": slug.current
    }
  `);

  // ✅ Supabase hidden works
  const supabase = createClient(
    import.meta.env.SUPABASE_URL,
    import.meta.env.SUPABASE_SERVICE_ROLE_KEY
  );

  const { data: hiddenSlugs } = await supabase
    .from("private_posts_preview")
    .select("slug");

  const all = [
    ...(publicSlugs || []).map((x) => x.slug),
    ...(hiddenSlugs || []).map((x) => x.slug),
  ];

  const unique = [...new Set(all)];

  return unique.map((slug) => ({ params: { slug } }));
}

const { slug } = Astro.params;

// ✅ Try Sanity first
const post = await getPostBySlug(slug);
const isPublic = !!post;

// ✅ Pagination + creditbox only for public Sanity posts
let prev = null;
let next = null;

if (isPublic) {
  const baseDate = post.postDate;
  const postType = post.postType ?? "work";

  const neighbors = baseDate
    ? await client.fetch(
        `
        {
          "prev": *[_type=="post"
            && postType == $type
            && defined(slug.current)
            && defined(postDate)
            && !(_id in path("drafts.**"))
            && postDate < $d]
            | order(postDate desc)[0]{
              title,
              "slug": slug.current
            },

          "next": *[_type=="post"
            && postType == $type
            && defined(slug.current)
            && defined(postDate)
            && !(_id in path("drafts.**"))
            && postDate > $d]
            | order(postDate asc)[0]{
              title,
              "slug": slug.current
            }
        }
        `,
        { type: postType, d: baseDate }
      )
    : { prev: null, next: null };

  prev = neighbors?.prev ?? null;
  // ✅ WRAP: if no prev (oldest post), send to newest post
  if (!prev) {
    prev = await client.fetch(
      `
      *[_type=="post"
        && postType == $type
        && defined(slug.current)
        && defined(postDate)
        && !(_id in path("drafts.**"))
        && slug.current != $slug
      ]
      | order(postDate desc)[0]{
        title,
        "slug": slug.current
      }
      `,
      { type: postType, slug }
    );
  }

}

const hasCredit = !!post?.creditbox?.length;
---

{isPublic ? (
  <Layout title={`Dzastins Zavadzkis—${post.title}`}>
    <NavForPost slot="overlay" title={post.title} />
    <div class="post-page">
      <Feed>
        <Post post={post} />

      <nav class="post-pagination" aria-label="Work post navigation">
        {/* LEFT */}
        {hasCredit ? (
          <div class="creditbox" aria-label="Credits">
            <PortableText value={post.creditbox} />
          </div>
        ) : null}

        {/* RIGHT */}
        {prev ? (
          <a class="prev-only" href={`/works/${prev.slug}`} aria-label="Previous project">
            <span class="label">{prev.title}</span>
            <span class="arrow">→</span>
          </a>
        ) : null}
      </nav>

      </Feed>
    </div>
  </Layout>
) : (
  <Layout title="Dzastins Zavadzkis—Hidden Project">
    <div class="post-page">
      <Feed>
        <NavForPost title="Hidden Project" />

        {/* ✅ Locked UI (client decides if unlocked) */}
        <div class="private-wrapper">
          <div class="private-locked" data-private-locked>
            <p>This project is locked.</p>
            <a class="page-btn" href="/works">Go to Works → Unlock</a>
          </div>

          {/* ✅ actual private post UI (only show when unlocked) */}
          <div class="private-post" data-private-post>
            <PrivatePostClient slug={slug} client:load />
          </div>
        </div>
      </Feed>
    </div>

    {/* ✅ localStorage unlock check */}
    <script is:inline>
      (function () {
        const KEY = "private_ui_until";
        const until = Number(localStorage.getItem(KEY) || 0);
        const unlocked = Date.now() < until;

        const lockedEl = document.querySelector("[data-private-locked]");
        const postEl = document.querySelector("[data-private-post]");

        if (!lockedEl || !postEl) return;

        if (unlocked) {
          lockedEl.style.display = "none";
          postEl.style.display = "block";
        } else {
          lockedEl.style.display = "block";
          postEl.style.display = "none";
        }
      })();
    </script>
  </Layout>
)}

<style lang="scss">
  .post-page {
    padding-bottom: 40px;
  }

  .post-pagination {
  margin-top: 40px;
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 10px;
}

.prev-only {
  height: 42px;
  border-radius: var(--br);
  padding: 0 14px;
  text-decoration: none;
  color: #000;

  display: inline-flex;
  align-items: center;
  gap: 10px;

  max-width: 48%;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;

  box-shadow: var(--box-shadow);
  backdrop-filter: var(--backdrop-filter);
  -webkit-backdrop-filter: var(--backdrop-filter);

  transition: box-shadow 0.15s ease, backdrop-filter 0.15s ease;
}

.prev-only:hover {
  box-shadow: 0 0 3px rgba(122, 122, 122, 0.4) inset;
  backdrop-filter: var(--backdrop-filter-pressed);
  -webkit-backdrop-filter: var(--backdrop-filter-pressed);
}

.prev-only .label {
  overflow: hidden;
  text-overflow: ellipsis;
}

.prev-only .arrow {
  flex: 0 0 auto;
}



  .creditbox {
    max-width: 48%;
    white-space: normal;
    overflow: visible;
    text-overflow: unset;
    font-size: calc(var(--fz) * 0.6);
    line-height: calc(var(--lh) * 0.65);
    text-align: left;
  }

  .creditbox :global(p) {
    margin: 0;
  }

  .creditbox :global(a) {
    text-decoration: underline;
    color: var(--gray);
  }

  /* ✅ Private lock wrapper */
  .private-wrapper {
    margin-top: 20px;
  }

  .private-locked {
    display: none;
    text-align: center;
    font-size: calc(var(--fz) * 0.75);
    opacity: 0.8;
  }

  .private-post {
    display: none;
  }
</style>
